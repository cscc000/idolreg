<!DOCTYPE html>
<html>

<head>
    <title>Idol finder</title>
    <style>
        .container {
            width: 550px;
            margin: auto
        }

        .field {
            padding: 8px 2px
        }

        .error {
            color: #f00
        }
    </style>
</head>

<body>
    <script type="text/javascript" src="./face-api.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script>
        var matcher, tags;
        $(document).ready(() => {
            Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('./models'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./models'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./models')
            ]).then(() => {
                $.get("./samples.json", (samples) => {
                    let d = [];
                    tags = [];
                    for (var i = 0; i < samples.length; i++) {
                        let a = [];
                        samples[i].d.forEach((v) => {
                            a.push(Float32Array.from(v));
                        });
                        d.push(new faceapi.LabeledFaceDescriptors(i.toString(), a));
                        tags.push(samples[i].t);
                    }
                    console.log(d);
                    matcher = new faceapi.FaceMatcher(d, 0.5);
                    console.log(matcher);
                    function loadImg(uri) {
                        let img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = async function () {
                            var dim;
                            if (img.width < 500) {
                                dim = { width: img.width, height: img.height };
                            } else {
                                dim = { width: 500, height: Math.round(img.height * 500 / img.width) };
                            }
                            $("#main-canvas").attr(dim);
                            let cv = $("#main-canvas")[0];
                            cv.getContext("2d").drawImage(img, 0, 0, dim.width, dim.height);
                            $("#info-msg").html("Calculating...");
                            setTimeout(async ()  => {
                                let detections = await faceapi.detectAllFaces(img).withFaceLandmarks().withFaceDescriptors();
                                console.log(detections);
                                if (detections.length == 0) {
                                    $("#info-msg").html("");
                                    $("#error-msg").html("No face detected!");
                                    return;
                                }
                                let results = [];
                                for(var i = 0; i < detections.length; i++) {
                                    let match = matcher.findBestMatch(detections[i].descriptor);
                                    console.log(match);
                                    if (match._label != 'unknown' && match._distance < 0.4) {
                                        results.push(tags[parseInt(match._label)]);
                                    } else {
                                        results.push(undefined);
                                    }
                                }
                                let html = `Found ${detections.length} faces:<br><ul>`, ii = 1;
                                for(var t of results) {
                                    html += `<li>Face #${ii++} `;
                                    if (t) {
                                        html += `has tags: ${t.join(', ')}`;
                                    } else {
                                        html += 'has no tag';
                                    }
                                    html += '</li>';
                                }
                                $("#info-msg").html(html + '</ul>');
                                $("#error-msg").html("");
                            }, 50);
                        };
                        img.src = uri;
                    }
                    $("#load-btn").click(() => {
                        loadImg($("#img-url").val());
                    });
                    $("#local-img").change((evt) => {
                        var tgt = evt.target || window.event.srcElement,
                            files = tgt.files;
                        // FileReader support
                        if (FileReader && files && files.length) {
                            var fr = new FileReader();
                            fr.onload = () => loadImg(fr.result);
                            fr.readAsDataURL(files[0]);
                        }
                    });
                    $(".img-src").show();
                    $("#info-msg").html("Ready!!!");
                }).fail(() => {
                    $('#error-msg').html('ERROR: Cannot load samples!');
                });
            })
        });
    </script>
    <div class="container">
        <div class="field img-src" style="display: none">
            Input URL of the image: <input type="text" id="img-url"> <input type="button" value="Load" id="load-btn">
        </div>
        <div class="field img-src" style="display: none">
            or, choose image from your computer: <input type="file" id="local-img">
        </div>
        <div class="field picture">
            <canvas id="main-canvas" width=500></canvas>
        </div>
        <div class="field error" id="error-msg">
        </div>
        <div class="field info" id="info-msg">
            Loading...
        </div>
    </div>
</body>

</html>